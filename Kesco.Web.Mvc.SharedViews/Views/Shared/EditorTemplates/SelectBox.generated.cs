#pragma warning disable 1591
//------------------------------------------------------------------------------
// <auto-generated>
//     Этот код создан программой.
//     Исполняемая версия:4.0.30319.225
//
//     Изменения в этом файле могут привести к неправильной работе и будут потеряны в случае
//     повторной генерации кода.
// </auto-generated>
//------------------------------------------------------------------------------

namespace Kesco.Web.Mvc.SharedViews.Views.Shared.EditorTemplates
{
    using System;
    using System.Collections.Generic;
    using System.IO;
    using System.Linq;
    using System.Net;
    using System.Text;
    using System.Web;
    using System.Web.Helpers;
    using System.Web.Mvc;
    using System.Web.Mvc.Ajax;
    using System.Web.Mvc.Html;
    using System.Web.Routing;
    using System.Web.Security;
    using System.Web.UI;
    using System.Web.WebPages;
    
    #line 2 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using FluentJson;
    
    #line default
    #line hidden
    
    #line 3 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using Kesco;
    
    #line default
    #line hidden
    
    #line 4 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using Kesco.DataAccess;
    
    #line default
    #line hidden
    
    #line 5 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using Kesco.Web.Mvc;
    
    #line default
    #line hidden
    
    #line 8 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using Kesco.Web.Mvc.SharedViews;
    
    #line default
    #line hidden
    
    #line 9 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using Kesco.Web.Mvc.SharedViews.ComponentModel;
    
    #line default
    #line hidden
    
    #line 11 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using Kesco.Web.Mvc.SharedViews.Controls;
    
    #line default
    #line hidden
    
    #line 10 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using Kesco.Web.Mvc.SharedViews.Models;
    
    #line default
    #line hidden
    
    #line 6 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using Kesco.Web.Mvc.UI;
    
    #line default
    #line hidden
    
    #line 7 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using Kesco.Web.Mvc.UI.ComponentModel.DataAnnotations;
    
    #line default
    #line hidden
    
    #line 12 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
    using Kesco.Web.Mvc.UI.Controls.DataAccess;
    
    #line default
    #line hidden
    
    [System.CodeDom.Compiler.GeneratedCodeAttribute("RazorGenerator", "1.4.1.0")]
    [System.Web.WebPages.PageVirtualPathAttribute("~/Views/Shared/EditorTemplates/SelectBox.cshtml")]
    public class SelectBox : Kesco.Web.Mvc.SharedViews.SharedViewPage<int?>
    {
        public SelectBox()
        {
        }
        public override void Execute()
        {













            
            #line 13 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
  
	string id = ViewData.TemplateInfo.GetFullHtmlFieldId("");
	string name = ViewData.TemplateInfo.HtmlFieldPrefix;
	ModelMetadata metaData = ViewData.ModelMetadata;
    
	
            
            #line default
            #line hidden

            
            #line 18 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
                                                                                                                  
	if (!metaData.AdditionalValues.ContainsKey(KescoSelectAttribute.AdditionalValuesKey_SelectBox)) {
		throw new Exception(String.Format(
				"Неверное использование шаблона SelectBox. Ожидаемый атрибут-дескриптор '{1}' не найден для свойства {0}.",
				metaData.PropertyName,
				typeof(KescoSelectAttribute)
			));
	}

	var descriptor = metaData.AdditionalValues[KescoSelectAttribute.AdditionalValuesKey_SelectBox]
		as KescoSelectAttribute;

	if (descriptor == null) {
		throw new Exception(String.Format(
			"Неверное использование шаблона SelectBox. Атрибут-дескриптор для свойства '{0}' имеет неверный тип {1}.",
				metaData.PropertyName,
				metaData.AdditionalValues[KescoSelectAttribute.AdditionalValuesKey_SelectBox].GetType()
		));
	}

	Kesco.DataAccess.IAccessor accessor = BLToolkit.Reflection.TypeAccessor.CreateInstanceEx(
			descriptor.EntityAccessorType
		) as Kesco.DataAccess.IAccessor;
	object searchParameters = null;
	if (accessor != null) {
		if (accessor is Kesco.DataAccess.IEntitySearchable) {
			searchParameters = BLToolkit.Reflection.TypeAccessor.CreateInstanceEx(
					((Kesco.DataAccess.IEntitySearchable)accessor).GetSearchParametersType()
				);
			if (metaData.AdditionalValues.ContainsKey(KescoSelectAttribute.AdditionalValuesKey_SelectBoxSearchParameters)) {
				var searchParametersAttribute = metaData.AdditionalValues[KescoSelectAttribute.AdditionalValuesKey_SelectBoxSearchParameters]
					as KescoSelectSearchParametersAttribute;

				if (searchParametersAttribute != null) {
					BLToolkit.Mapping.Map.ObjectToObject(searchParametersAttribute, searchParameters);
					searchParametersAttribute.CLID = descriptor.CLID;
				}
			}
		}
	}

	// Получим начальные значения
	string value = "";
	string label = "";

	if (Model.HasValue && Model.Value != 0 && descriptor.EntityAccessorType != null) {
		value = Model.ToString();
		label = String.Format("#{0}", value);
		if (accessor != null) {
			object entry = accessor.GetInstance(value);
			if (entry != null) {
				if (accessor is Kesco.Web.Mvc.UI.Controls.DataAccess.IKescoSelectAccessor) {
					label = ((IKescoSelectAccessor)accessor).GetInstanceDisplayName(entry);
				} else if (entry is Kesco.ObjectModel.IFriendlyNamed) {
					label = ((Kesco.ObjectModel.IFriendlyNamed)entry).GetInstanceFriendlyName();
				}
			}
		}
	}


	// Получаем массив команд.
	var commands = new KescoSelectCommandAttribute[] { };
	if (metaData.AdditionalValues.ContainsKey(KescoSelectAttribute.AdditionalValuesKey_SelectBoxCommands)) {
		commands = metaData.AdditionalValues[KescoSelectAttribute.AdditionalValuesKey_SelectBoxCommands]
			as KescoSelectCommandAttribute[] ?? new KescoSelectCommandAttribute[] { };
	}

	// Дескриптор получен, начинаем строить элемент управления SELECT
	var selectBox = Html.KescoLookup(name, id).SelfInitialized(false).Value("", "")
		.KeyField(descriptor.KeyField).DisplayField(descriptor.DisplayField)
		.Value(value, label)
		.Required(descriptor.IsRequired || metaData.IsRequired)
		.Autocomplete(
			Url.FullPathAction(descriptor.AutocompleteAction, descriptor.AutocompleteController),
			descriptor.AutocompleteLimit)
		.ShowSearchButton(descriptor.ShowSearchButton)
		// Установим показывать кнопку просмотра только в том случае, если указано и есть команда 'view'
		.ShowViewButton(descriptor.ShowSearchButton && commands.Any(c => c.Command == "view"))
		.ClientEvents((events) => {
			events.OnCommand = @" 
                    function (event, ui) {{
							var parameters = ko.toJS(ViewModel.{2}.__SearchParameters || {{}});
							var $lookup = $('#{0}');
							var item = $lookup.selectBox('getValue');
							$lookup.selectBox('clearFocusing', true);
							ui.item.parameters = $.extend(parameters, ui.item.parameters || {{ Search: encodeURIComponent(item.label) }});
							var data = $.extend({{ control: '{0}', mode: 0 }}, ui.item || {{}});
                            var url = '{1}';
                            setTimeout(function() {{
								$.ajax({{
									type: 'POST',
									url: url,
									contentType: 'application/json; charset=utf-8',
									data: ko.toJSON(data),
									beforeSend: function() {{ }},
									success: function( data, status ) {{ }},
									error: function() {{ }},
									complete: function () {{ 
									}}
								}});
							}}, 10);
					    
		            }}".FormatWith(
						id,
						Url.FullPathAction("Dispatch", descriptor.AutocompleteController),
						name
					);
			if (!String.IsNullOrWhiteSpace(descriptor.OnFormatItemClientFunction)) {
				events.OnFormatItem = String.Format(@" function (item) {{
						if ($.isFunction(window.{0})) return {0}(item);
						return item.label;
					}}", descriptor.OnFormatItemClientFunction);
			}
			if (!String.IsNullOrWhiteSpace(descriptor.OnRequestClientFunction)) {
				events.OnRequest = String.Format(@" function (request) {{
						if ($.isFunction(window.{0})) return {0}(request);
					}}", descriptor.OnRequestClientFunction);
			}
		});

	// Добавление команд/ссылок в меню.
	var links = commands
		.Where(c => c is KescoSelectLinkAttribute)
		.Select(c => (KescoSelectLinkAttribute)c)
		.OrderBy(c => c.SortOrder)
		.All(c => {
			selectBox.AddLink(
					c.Command,
					c.GetCommandText(),
					c.CommandIcon,
					c.ShowCondition
				);
			return true;
		});

	// Объединяем HTML атрибуты для элемента управления
	var htmlAttributes = Html.MergeHtmlAttributes((object) ViewBag.HtmlAttributes);
	// Укажим data-bind для библиотеки knockout
	htmlAttributes["data-actual"] = true;
	htmlAttributes.PrependInValue("data-bind", ",", "selectBox: " + name);

	selectBox.HtmlAttributes(htmlAttributes);


            
            #line default
            #line hidden

            
            #line 162 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
Write(Html.Raw(selectBox.ToString()));

            
            #line default
            #line hidden
WriteLiteral("\r\n");


            
            #line 163 "..\..\Views\Shared\EditorTemplates\SelectBox.cshtml"
  
	
	Html.RegisterScript(@"
		
		;(function(scope, $) {{
			scope.ViewModel.{1}.__SearchParameters = {2};
		}})(window, jQuery);
		
	".FormatWith(id, name, Knockout.ToViewModel(searchParameters)));

            
            #line default
            #line hidden

        }
    }
}
#pragma warning restore 1591
